<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Workflow</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        .task-item {
            margin-bottom: 20px;
        }
        .dropdown {
            width: 200px;
        }
        .dropdown.disabled {
            background-color: #e9ecef;
            pointer-events: none;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center">Test Workflow Simulation</h1>
        <div id="taskList" class="mt-4"></div>
    </div>

    <script>
        const displayData = JSON.parse(localStorage.getItem('displayData')) || [];
        const insertsData = JSON.parse(localStorage.getItem('insertsData')) || {};
        console.log('Loaded displayData:', displayData);
        console.log('Loaded insertsData:', insertsData);

        // Helper to sort tasks by milestone and task number
        function sortTasksByMilestoneAndTaskNumber(tasks) {
            return tasks.sort((a, b) => {
                if (parseInt(a.milestone) !== parseInt(b.milestone)) {
                    return parseInt(a.milestone) - parseInt(b.milestone);
                }
                return parseInt(a.taskNumber) - parseInt(b.taskNumber);
            });
        }

        // Render all tasks for the main workflow
        function renderTasks() {
            console.log('Rendering main workflow tasks...');
            const taskList = document.getElementById('taskList');
            taskList.innerHTML = '';

            const mainWorkflow = displayData.find(wf => wf.workflowId === 'mainWorkflow');
            if (!mainWorkflow) {
                console.error('Main workflow not found.');
                return;
            }

            renderWorkflowTasks(mainWorkflow.tasks, 'mainWorkflow', taskList);
        }

        // Render tasks for a specific workflow
        function renderWorkflowTasks(tasks, workflowId, container, insertedAfter = null) {
            const sortedTasks = sortTasksByMilestoneAndTaskNumber(tasks);
            console.log(`Sorted tasks for workflow ${workflowId}:`, sortedTasks);

            const milestones = sortedTasks.map(task => parseInt(task.milestone));
            const lowestMilestone = Math.min(...milestones);
            console.log(`Workflow: ${workflowId} | Lowest milestone: ${lowestMilestone}`);

            const visibleTasks = sortedTasks.filter(task => parseInt(task.milestone) === lowestMilestone);
            console.log(`Visible tasks for milestone ${lowestMilestone}:`, visibleTasks);

            visibleTasks.forEach(task => {
                const taskDiv = document.createElement('div');
                taskDiv.className = 'task-item';
                taskDiv.innerHTML = `<h5>Task: ${task.name}</h5>`;

                const dropdown = document.createElement('select');
                dropdown.className = 'form-select dropdown';
                dropdown.innerHTML = '<option value="">Select Result</option>';

                task.results.forEach(result => {
                    dropdown.innerHTML += `<option value="${result.result}">${result.result}</option>`;
                });

                dropdown.disabled = true; // Disable all dropdowns initially

                dropdown.addEventListener('change', () => {
                    const selectedValue = dropdown.value;
                    console.log(`Task "${task.name}" selected result:`, selectedValue);
                    if (selectedValue) {
                        dropdown.disabled = true;
                        dropdown.classList.add('disabled');

                        const insertKey = `${workflowId}-${task.id}-${selectedValue}`;
                        const insertValue = insertsData[insertKey];
                        console.log(`Insert key: ${insertKey} | Insert value:`, insertValue);

                        if (insertValue) {
                            handleInsert(insertValue, taskDiv, workflowId);
                        }

                        enableNextTask(task, sortedTasks, container);
                    }
                });

                taskDiv.appendChild(dropdown);

                if (insertedAfter) {
                    insertedAfter.insertAdjacentElement('afterend', taskDiv);
                    insertedAfter = taskDiv; // Update reference for further inserts
                } else {
                    container.appendChild(taskDiv);
                }

                // Enable the first task in the milestone
                if (visibleTasks.indexOf(task) === 0) {
                    dropdown.disabled = false;
                    dropdown.classList.remove('disabled');
                }
            });
        }

        // Handle inserts (tasks or sub-workflows)
        function handleInsert(insertValue, currentTaskDiv, workflowId) {
            console.log(`Handling insert: ${insertValue}`);

            const insertedTask = displayData
                .flatMap(workflow => workflow.tasks)
                .find(task => insertValue.includes(task.id));

            if (insertedTask) {
                console.log(`Inserting individual task: ${insertedTask.name}`);
                insertTaskDirectly(insertedTask, currentTaskDiv, workflowId); // Pass workflowId here
            } else {
                const subWorkflow = displayData.find(workflow => workflow.title === insertValue);
                if (subWorkflow) {
                    console.log(`Inserting sub-workflow: ${subWorkflow.title}`);
                    insertSubWorkflow(subWorkflow.tasks, currentTaskDiv, subWorkflow.workflowId); // Pass subWorkflow.workflowId here
                } else {
                    console.error('Sub-workflow or task not found for insert value:', insertValue);
                }
            }
        }

        // Insert a single task directly after the current task
        function insertTaskDirectly(task, currentTaskDiv, workflowId) {
            console.log(`Inserting individual task: ${task.name} with results:`, task.results);

            const taskDiv = document.createElement('div');
            taskDiv.className = 'task-item';
            taskDiv.innerHTML = `<h5>Task: ${task.name}</h5>`;

            const dropdown = document.createElement('select');
            dropdown.className = 'form-select dropdown';
            dropdown.innerHTML = '<option value="">Select Result</option>';

            // Populate dropdown with task results
            task.results.forEach(result => {
                dropdown.innerHTML += `<option value="${result.result}">${result.result}</option>`;
            });

            dropdown.disabled = false;
            dropdown.classList.remove('disabled');

            dropdown.addEventListener('change', () => {
                const selectedValue = dropdown.value;
                console.log(`Task "${task.name}" selected result:`, selectedValue);
                if (selectedValue) {
                    dropdown.disabled = true;
                    dropdown.classList.add('disabled');

                    const insertKey = `${workflowId}-${task.id}-${selectedValue}`;
                    const insertValue = insertsData[insertKey];
                    console.log(`Insert key: ${insertKey} | Insert value:`, insertValue);

                    if (insertValue) {
                        handleInsert(insertValue, taskDiv, workflowId);
                    }
                }
            });

            taskDiv.appendChild(dropdown);
            currentTaskDiv.insertAdjacentElement('afterend', taskDiv);
        }

        // Insert sub-workflow tasks immediately after the current task
        function insertSubWorkflow(tasks, currentTaskDiv, workflowId) {
            const sortedTasks = sortTasksByMilestoneAndTaskNumber(tasks);
            const lowestMilestoneTasks = sortedTasks.filter(task => parseInt(task.milestone) === parseInt(sortedTasks[0].milestone));
            console.log(`Inserting tasks for lowest milestone in sub-workflow:`, lowestMilestoneTasks);

            let lowestTaskNumber = Math.min(...lowestMilestoneTasks.map(task => parseInt(task.taskNumber)));
            console.log(`Lowest task number in milestone: ${lowestTaskNumber}`);

            lowestMilestoneTasks.forEach(task => {
                console.log(`Inserting sub-workflow task: ${task.name} with results:`, task.results);
                insertTaskDirectly(task, currentTaskDiv, workflowId); // Pass workflowId for each task
                currentTaskDiv = currentTaskDiv.nextElementSibling; // Update reference for further inserts

                // Enable dropdowns for tasks with the lowest task number
                if (parseInt(task.taskNumber) === lowestTaskNumber) {
                    const dropdown = currentTaskDiv.querySelector('select');
                    dropdown.disabled = false;
                    dropdown.classList.remove('disabled');
                    console.log(`Enabled dropdown for task: ${task.name}`);
                }
            });
        }

        // Enable the next task in the same milestone
        function enableNextTask(currentTask, allTasks, container) {
            const currentMilestone = parseInt(currentTask.milestone);
            const currentTaskNumber = parseInt(currentTask.taskNumber);

            const nextTask = allTasks.find(task =>
                parseInt(task.milestone) === currentMilestone &&
                parseInt(task.taskNumber) > currentTaskNumber
            );

            if (nextTask) {
                console.log(`Enabling next task: ${nextTask.name}`);
                const taskDiv = Array.from(container.querySelectorAll('.task-item')).find(div =>
                    div.querySelector('h5').innerText.includes(nextTask.name)
                );

                if (taskDiv) {
                    const dropdown = taskDiv.querySelector('select');
                    dropdown.disabled = false;
                    dropdown.classList.remove('disabled');
                }
            }
        }

        // Initial rendering
        renderTasks();
    </script>
</body>
</html>
