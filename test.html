<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Workflow</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        .task-item {
            margin-bottom: 20px;
        }
        .dropdown {
            width: 200px;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center">Test Workflow Simulation</h1>
        <div id="taskList" class="mt-4"></div>
    </div>

    <script>
        const displayData = JSON.parse(localStorage.getItem('displayData')) || [];
        const insertsData = JSON.parse(localStorage.getItem('insertsData')) || {};
        console.log('Loaded displayData:', displayData);
        console.log('Loaded insertsData:', insertsData);

        // Helper to sort tasks by milestone and task number
        function sortTasksByMilestone(tasks) {
            console.log('Sorting tasks:', tasks);
            return tasks.sort((a, b) => {
                if (a.milestone !== b.milestone) {
                    return a.milestone - b.milestone;
                }
                return a.taskNumber - b.taskNumber;
            });
        }

        // Render the tasks based on displayData
        function renderTasks() {
            console.log('Rendering tasks...');
            const taskList = document.getElementById('taskList');
            taskList.innerHTML = '';

            const mainWorkflow = displayData.find(workflow => workflow.workflowId === 'mainWorkflow');
            if (!mainWorkflow) {
                console.log('No mainWorkflow found in displayData');
                return;
            }

            const tasks = sortTasksByMilestone(mainWorkflow.tasks);
            console.log('Sorted tasks:', tasks);

            let lowestMilestone = Math.min(...tasks.map(task => task.milestone));
            let currentMilestoneTasks = tasks.filter(task => task.milestone == lowestMilestone);
            console.log('Lowest milestone tasks:', currentMilestoneTasks);

            currentMilestoneTasks.forEach(task => {
                const taskDiv = document.createElement('div');
                taskDiv.className = 'task-item';
                taskDiv.innerHTML = `<h5>Task: ${task.name}</h5>`;

                const dropdown = document.createElement('select');
                dropdown.className = 'form-select dropdown';
                dropdown.innerHTML = '<option value="">Select Result</option>';

                task.results.forEach(result => {
                    dropdown.innerHTML += `<option value="${result.result}">${result.result}</option>`;
                });

                dropdown.addEventListener('change', () => {
                    const selectedValue = dropdown.value;
                    console.log(`Selected value for task "${task.name}":`, selectedValue);
                    if (selectedValue) {
                        const insertKey = `${mainWorkflow.workflowId}-${task.id}-${selectedValue}`;
                        const insertValue = insertsData[insertKey];
                        console.log(`Insert key: ${insertKey}, Insert value:`, insertValue);
                        if (insertValue) {
                            handleInsert(insertValue, task);
                        }
                    }
                });

                taskDiv.appendChild(dropdown);
                taskList.appendChild(taskDiv);
            });
        }

        // Handle inserts (individual tasks or sub-workflows)
        function handleInsert(insertValue, currentTask) {
            console.log('Handling insert for:', insertValue);
            const taskList = document.getElementById('taskList');
            const currentTaskIndex = Array.from(taskList.children).findIndex(taskDiv =>
                taskDiv.querySelector('h5').innerText.includes(currentTask.name)
            );
        
            if (insertValue.includes('-')) {
                const [taskName, taskId] = insertValue.split('-');
                const insertedTask = displayData
                    .flatMap(workflow => workflow.tasks)
                    .find(task => task.id === taskId);
        
                if (insertedTask) {
                    const insertDiv = document.createElement('div');
                    insertDiv.className = 'task-item';
                    insertDiv.innerHTML = `<h5>Task: ${insertedTask.name}</h5>`;
        
                    const dropdown = document.createElement('select');
                    dropdown.className = 'form-select dropdown';
                    dropdown.innerHTML = '<option value="">Select Result</option>';
        
                    insertedTask.results.forEach(result => {
                        dropdown.innerHTML += `<option value="${result.result}">${result.result}</option>`;
                    });
        
                    dropdown.addEventListener('change', () => {
                        const selectedValue = dropdown.value;
                        console.log(`Selected value for task "${insertedTask.name}":`, selectedValue);
                        if (selectedValue) {
                            const insertKey = `mainWorkflow-${taskId}-${selectedValue}`;
                            const nextInsertValue = insertsData[insertKey];
                            console.log(`Insert key: ${insertKey}, Next insert value:`, nextInsertValue);
                            if (nextInsertValue) {
                                handleInsert(nextInsertValue, insertedTask);
                            }
                        }
                    });
        
                    insertDiv.appendChild(dropdown);
                    taskList.insertBefore(insertDiv, taskList.children[currentTaskIndex + 1]);
                    console.log(`Inserted individual task with dropdown: ${insertedTask.name}`);
                } else {
                    console.log('Task not found for ID:', taskId);
                }
            } else {
                const subWorkflow = displayData.find(workflow => workflow.title === insertValue);
                if (subWorkflow) {
                    subWorkflow.tasks.forEach(subTask => {
                        const insertDiv = document.createElement('div');
                        insertDiv.className = 'task-item';
                        insertDiv.innerHTML = `<h5>Task: ${subTask.name}</h5>`;
        
                        const dropdown = document.createElement('select');
                        dropdown.className = 'form-select dropdown';
                        dropdown.innerHTML = '<option value="">Select Result</option>';
        
                        subTask.results.forEach(result => {
                            dropdown.innerHTML += `<option value="${result.result}">${result.result}</option>`;
                        });
        
                        dropdown.addEventListener('change', () => {
                            const selectedValue = dropdown.value;
                            console.log(`Selected value for task "${subTask.name}":`, selectedValue);
                            if (selectedValue) {
                                const insertKey = `${subWorkflow.workflowId}-${subTask.id}-${selectedValue}`;
                                const nextInsertValue = insertsData[insertKey];
                                console.log(`Insert key: ${insertKey}, Next insert value:`, nextInsertValue);
                                if (nextInsertValue) {
                                    handleInsert(nextInsertValue, subTask);
                                }
                            }
                        });
        
                        insertDiv.appendChild(dropdown);
                        taskList.insertBefore(insertDiv, taskList.children[currentTaskIndex + 1]);
                        console.log(`Inserted sub-workflow task with dropdown: ${subTask.name}`);
                    });
                } else {
                    console.log('Sub-workflow not found for:', insertValue);
                }
            }
        }


        // Initial rendering
        renderTasks();
    </script>
</body>
</html>
