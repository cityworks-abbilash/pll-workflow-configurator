<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Workflow</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        .task-item {
            margin-bottom: 20px;
        }
        .dropdown {
            width: 200px;
        }
        .dropdown.disabled {
            background-color: #e9ecef;
            pointer-events: none;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center">Test Workflow Simulation</h1>
        <div id="taskList" class="mt-4"></div>
    </div>

    <script>
        const displayData = JSON.parse(localStorage.getItem('displayData')) || [];
        const insertsData = JSON.parse(localStorage.getItem('insertsData')) || {};
        console.log('Loaded displayData:', displayData);
        console.log('Loaded insertsData:', insertsData);

        // Sort tasks by milestone and task number
        function sortTasksByMilestoneAndTaskNumber(tasks) {
            return tasks.sort((a, b) => {
                if (a.milestone !== b.milestone) return a.milestone - b.milestone;
                return a.taskNumber - b.taskNumber;
            });
        }

        // Render the main workflow
        function renderTasks() {
            console.log('Rendering main workflow tasks...');
            const taskList = document.getElementById('taskList');
            taskList.innerHTML = ''; // Clear previous tasks

            const mainWorkflow = displayData.find(wf => wf.workflowId === 'mainWorkflow');
            if (!mainWorkflow) {
                console.error('Main workflow not found.');
                return;
            }

            renderWorkflowTasks(mainWorkflow.tasks, 'mainWorkflow');
        }

        // Render tasks for a workflow
        function renderWorkflowTasks(tasks, workflowId) {
            const taskList = document.getElementById('taskList');
            const sortedTasks = sortTasksByMilestoneAndTaskNumber(tasks);

            // Find the lowest milestone tasks
            const lowestMilestone = Math.min(...sortedTasks.map(task => task.milestone));
            const visibleTasks = sortedTasks.filter(task => task.milestone === lowestMilestone);
            console.log(`Workflow: ${workflowId}, Lowest milestone: ${lowestMilestone}`, visibleTasks);

            let previousDropdown = null;

            visibleTasks.forEach(task => {
                const taskDiv = document.createElement('div');
                taskDiv.className = 'task-item';
                taskDiv.innerHTML = `<h5>Task: ${task.name}</h5>`;

                const dropdown = document.createElement('select');
                dropdown.className = 'form-select dropdown';
                dropdown.innerHTML = '<option value="">Select Result</option>';

                task.results.forEach(result => {
                    dropdown.innerHTML += `<option value="${result.result}">${result.result}</option>`;
                });

                // Enable the first dropdown and disable others
                if (!previousDropdown) {
                    dropdown.disabled = false;
                    dropdown.classList.remove('disabled');
                } else {
                    dropdown.disabled = true;
                    dropdown.classList.add('disabled');
                }

                dropdown.addEventListener('change', () => {
                    const selectedValue = dropdown.value;
                    console.log(`Task "${task.name}" selected result:`, selectedValue);
                    if (selectedValue) {
                        dropdown.disabled = true;
                        dropdown.classList.add('disabled');

                        const insertKey = `${workflowId}-${task.id}-${selectedValue}`;
                        const insertValue = insertsData[insertKey];
                        console.log(`Insert key: ${insertKey}, Insert value:`, insertValue);

                        if (insertValue) {
                            handleInsert(insertValue, task, workflowId);
                        }

                        // Enable the next task in the same milestone
                        enableNextTask(task, sortedTasks);
                    }
                });

                taskDiv.appendChild(dropdown);
                taskList.appendChild(taskDiv);

                previousDropdown = dropdown;
            });
        }

        // Handle inserts (sub-workflows or individual tasks)
        function handleInsert(insertValue, currentTask, currentWorkflowId) {
            console.log('Handling insert for:', insertValue);

            if (insertValue.includes('-')) {
                // Individual task insertion
                const taskId = insertValue.split('-').pop();
                console.log(`Extracted taskId: ${taskId}`);

                const insertedTask = displayData
                    .flatMap(workflow => workflow.tasks)
                    .find(task => task.id === taskId);

                if (insertedTask) {
                    console.log(`Inserting individual task: ${insertedTask.name}`);
                    insertTaskDirectly(insertedTask);
                } else {
                    console.error('Task not found for ID:', taskId);
                }
            } else {
                // Sub-workflow insertion
                const subWorkflow = displayData.find(workflow => workflow.title === insertValue);
                if (subWorkflow) {
                    console.log(`Inserting sub-workflow: ${subWorkflow.title}`);
                    renderWorkflowTasks(subWorkflow.tasks, subWorkflow.workflowId);
                } else {
                    console.error('Sub-workflow not found:', insertValue);
                }
            }
        }

        // Enable the next task in the same milestone
        function enableNextTask(currentTask, allTasks) {
            const currentMilestone = currentTask.milestone;
            const currentTaskNumber = currentTask.taskNumber;

            const nextTask = allTasks.find(task =>
                task.milestone === currentMilestone && task.taskNumber > currentTaskNumber
            );

            if (nextTask) {
                console.log(`Enabling next task: ${nextTask.name}`);
                const taskDiv = Array.from(document.querySelectorAll('.task-item')).find(div =>
                    div.querySelector('h5').innerText.includes(nextTask.name)
                );

                if (taskDiv) {
                    const dropdown = taskDiv.querySelector('select');
                    dropdown.disabled = false;
                    dropdown.classList.remove('disabled');
                }
            }
        }

        // Insert a single task directly
        function insertTaskDirectly(task) {
            const taskList = document.getElementById('taskList');

            const taskDiv = document.createElement('div');
            taskDiv.className = 'task-item';
            taskDiv.innerHTML = `<h5>Task: ${task.name}</h5>`;

            const dropdown = document.createElement('select');
            dropdown.className = 'form-select dropdown';
            dropdown.innerHTML = '<option value="">Select Result</option>';

            task.results.forEach(result => {
                dropdown.innerHTML += `<option value="${result.result}">${result.result}</option>`;
            });

            dropdown.disabled = false;
            dropdown.classList.remove('disabled');

            dropdown.addEventListener('change', () => {
                const selectedValue = dropdown.value;
                console.log(`Task "${task.name}" selected result:`, selectedValue);
                if (selectedValue) {
                    dropdown.disabled = true;
                    dropdown.classList.add('disabled');
                }
            });

            taskDiv.appendChild(dropdown);
            taskList.appendChild(taskDiv);
        }

        // Initial render
        renderTasks();
    </script>
</body>
</html>
