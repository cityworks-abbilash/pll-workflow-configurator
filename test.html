<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Workflow</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        .disabled-dropdown {
            background-color: #e9ecef;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center">Test Workflow</h1>
        <div id="workflowContainer"></div>
    </div>
    <script>
        // Retrieve data from local storage
        const displayData = JSON.parse(localStorage.getItem('displayData')) || [];
        const insertsData = JSON.parse(localStorage.getItem('insertsData')) || {};
        let currentTasks = [];
        let currentMilestone = 1;

        function startTestWorkflow() {
            const mainWorkflow = displayData.find(wf => wf.workflowId === 'mainWorkflow');
            if (mainWorkflow) {
                currentTasks = [...mainWorkflow.tasks];
                displayTasksForMilestone();
            } else {
                document.getElementById('workflowContainer').innerHTML = '<p class="text-center">No main workflow found.</p>';
            }
        }

        function displayTasksForMilestone() {
            const workflowContainer = document.getElementById('workflowContainer');
            const tasksToShow = currentTasks.filter(task => parseInt(task.milestone) === currentMilestone);
            if (tasksToShow.length === 0) {
                workflowContainer.innerHTML += '<p class="text-center">Workflow complete! All tasks processed.</p>';
                return;
            }

            // Sort tasks by task number
            tasksToShow.sort((a, b) => parseInt(a.taskNumber) - parseInt(b.taskNumber));

            tasksToShow.forEach(task => {
                // Create task section
                const taskSection = document.createElement('div');
                taskSection.className = 'task-section mb-4';
                taskSection.innerHTML = `<h4>${task.name} (Milestone: ${task.milestone}, Task Number: ${task.taskNumber})</h4>`;

                // Add dropdown for task results
                const dropdown = document.createElement('select');
                dropdown.className = 'form-select mb-2';
                dropdown.innerHTML = '<option value="">Select a result</option>';
                task.results.forEach(result => {
                    const option = document.createElement('option');
                    option.value = result.result;
                    option.textContent = `${result.result} (${result.status || 'No Status'})`;
                    dropdown.appendChild(option);
                });

                // Disable dropdowns except for the lowest task number
                const lowestTaskNumber = Math.min(...tasksToShow.map(t => parseInt(t.taskNumber)));
                if (parseInt(task.taskNumber) !== lowestTaskNumber) {
                    dropdown.disabled = true;
                    dropdown.classList.add('disabled-dropdown');
                }

                // Handle dropdown selection
                dropdown.addEventListener('change', () => handleResultSelection(task, dropdown.value));

                taskSection.appendChild(dropdown);
                workflowContainer.appendChild(taskSection);
            });
        }

        function handleResultSelection(task, selectedResult) {
            const taskKey = `${task.workflowId}-${task.id}-${selectedResult}`;
            const insertSelection = insertsData[taskKey];

            if (insertSelection) {
                if (insertSelection.includes('Sub Workflow')) {
                    const subWorkflow = displayData.find(wf => wf.title === insertSelection);
                    if (subWorkflow) {
                        currentTasks.push(...subWorkflow.tasks);
                    }
                } else {
                    const taskId = insertSelection.split('-').pop();
                    const insertedTask = displayData
                        .flatMap(wf => wf.tasks)
                        .find(t => t.id === taskId);
                    if (insertedTask) {
                        currentTasks.push(insertedTask);
                    }
                }
            }

            // Enable the next dropdown
            const tasksInMilestone = currentTasks.filter(
                t => parseInt(t.milestone) === currentMilestone
            );
            tasksInMilestone
                .sort((a, b) => parseInt(a.taskNumber) - parseInt(b.taskNumber))
                .forEach((t, index) => {
                    const dropdown = document.querySelector(
                        `.task-section:nth-child(${index + 1}) select`
                    );
                    dropdown.disabled = false;
                    dropdown.classList.remove('disabled-dropdown');
                });

            // Progress to the next milestone if all tasks in the current one are completed
            const allCompleted = tasksInMilestone.every(t => t.results.some(r => r.result === selectedResult));
            if (allCompleted) {
                currentMilestone++;
                displayTasksForMilestone();
            }
        }

        startTestWorkflow();
    </script>
</body>
</html>
