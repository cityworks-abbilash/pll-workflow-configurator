<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workflow Display</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .task {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        .task.disabled {
            opacity: 0.6;
        }
        .task select:disabled {
            background-color: #f5f5f5;
        }
    </style>
</head>
<body>
    <h1>Workflow Display</h1>
    <div id="workflow-container"></div>

    <script>
        // Access data from localStorage
        const displayData = JSON.parse(localStorage.getItem('displayData'));
        const insertsData = JSON.parse(localStorage.getItem('insertsData'));

        // Ensure data is loaded correctly
        if (!displayData || !insertsData) {
            console.error("Required data is missing from localStorage. Please ensure 'displayData' and 'insertsData' exist.");
        } else {
            console.log("Data loaded successfully from localStorage.", { displayData, insertsData });
        }

        // State variables
        const workflows = {};
        let currentWorkflow = "mainWorkflow";

        // Initialize workflows
        displayData.forEach(workflow => {
            workflows[workflow.workflowId] = workflow;
        });

        const workflowContainer = document.getElementById('workflow-container');

        // Render tasks
        function renderWorkflow(workflowId) {
            const workflow = workflows[workflowId];
            const tasks = workflow.tasks.sort((a, b) => a.milestone - b.milestone || a.taskNumber - b.taskNumber);
            let lowestMilestone = Math.min(...tasks.map(t => t.milestone));
            let enabledTask = false; // Tracks whether a dropdown has been enabled
        
            workflowContainer.innerHTML = ''; // Clear previous tasks
        
            tasks.forEach(task => {
                const isLowestMilestone = task.milestone === lowestMilestone;
        
                const taskDiv = document.createElement('div');
                taskDiv.className = 'task';
        
                const taskTitle = document.createElement('h3');
                taskTitle.textContent = `${task.name} (Milestone: ${task.milestone}, Task: ${task.taskNumber})`;
                taskDiv.appendChild(taskTitle);
        
                const resultDropdown = document.createElement('select');
                resultDropdown.disabled = enabledTask; // Enable only the first dropdown in the sequence
        
                // Add default "Select result" option
                const defaultOption = document.createElement('option');
                defaultOption.value = "";
                defaultOption.textContent = "Select result";
                resultDropdown.appendChild(defaultOption);
        
                // Add task results to dropdown
                task.results.forEach(result => {
                    const option = document.createElement('option');
                    option.value = result.result;
                    option.textContent = result.result;
                    resultDropdown.appendChild(option);
                });
        
                resultDropdown.addEventListener('change', () => {
                    const selectedResult = resultDropdown.value;
        
                    if (selectedResult === "") {
                        // Do nothing if "Select result" is chosen
                        console.log("Please select a valid result.");
                        return;
                    }
        
                    resultDropdown.disabled = true; // Lock the dropdown after selection
                    console.log(`Selected result for task ${task.id}: ${selectedResult}`);
        
                    const insertKey = `${workflowId}-${task.id}-${selectedResult}`;
                    if (insertsData[insertKey]) {
                        const insertedTaskInfo = insertsData[insertKey];
                        console.log(`Inserting task: ${insertedTaskInfo}`);
        
                        const [newTaskName, newTaskId] = insertedTaskInfo.split('-');
                        const insertedTask = {
                            id: newTaskId,
                            name: newTaskName,
                            milestone: task.milestone,
                            taskNumber: task.taskNumber + 1,
                            results: task.results,
                            taskCode: task.taskCode
                        };
        
                        workflows[workflowId].tasks.push(insertedTask);
                        renderWorkflow(workflowId); // Re-render the workflow
                    } else {
                        // Enable the next dropdown in sequence
                        const nextTask = tasks.find(t => t.taskNumber > task.taskNumber && t.milestone === task.milestone);
                        if (nextTask) {
                            const nextDropdown = document.querySelector(`select[data-task-id="${nextTask.id}"]`);
                            if (nextDropdown) {
                                nextDropdown.disabled = false;
                            }
                        }
                    }
                });
        
                resultDropdown.dataset.taskId = task.id;
                taskDiv.appendChild(resultDropdown);
                workflowContainer.appendChild(taskDiv);
        
                // Enable the first task's dropdown only
                if (isLowestMilestone && !enabledTask) {
                    resultDropdown.disabled = false;
                    enabledTask = true; // Prevent enabling other dropdowns
                }
            });
        }


        renderWorkflow(currentWorkflow);
    </script>
</body>
</html>
