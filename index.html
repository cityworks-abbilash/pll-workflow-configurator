<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PLL Workflow Configurator</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center">Cityworks Workflow Configurator</h1>
        <p class="text-center">Upload your Draw.io (.drawio) file to configure your workflow.</p>

        <!-- File Upload Section -->
        <div class="mb-4">
            <label for="drawioUpload" class="form-label">Upload Draw.io File:</label>
            <input type="file" id="drawioUpload" class="form-control" accept=".drawio">
        </div>

        <!-- Task and Results Section -->
        <div id="taskContainer" class="d-none">
            <h3>Tasks and Results</h3>
            <div id="tasks" class="mt-3"></div>
        </div>
    </div>

    <script>
        document.getElementById('drawioUpload').addEventListener('change', handleFileUpload);

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                const fileContent = e.target.result;
                processDrawioFile(fileContent); // Extract tasks and lines
            };
            reader.readAsText(file);
        }

        function processDrawioFile(fileContent) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(fileContent, 'text/xml');

            const tasks = []; // Store tasks with their connections
            const connections = []; // Store all connections as { source, text }

            // Extract connections (lines) from the diagram
            xmlDoc.querySelectorAll('mxCell[edge="1"]').forEach(cell => {
                const source = cell.getAttribute('source');
                const lineText = cell.getAttribute('value') || 'No text associated with this line';

                if (source) {
                    connections.push({ source, text: lineText.trim() });
                }
            });

            // Extract tasks and associate their connections
            xmlDoc.querySelectorAll('mxCell[style*="rounded=1"]').forEach(cell => {
                const rawValue = cell.getAttribute('value') || 'Unnamed Task';
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = rawValue;
                const taskName = tempDiv.textContent.trim(); // Extract plain text

                const taskId = cell.getAttribute('id');
                const taskConnections = connections
                    .filter(connection => connection.source === taskId)
                    .map(connection => connection.text);

                tasks.push({ id: taskId, name: taskName, connections: taskConnections });
            });

            renderTasks(tasks);
        }

        function renderTasks(tasks) {
            const taskContainer = document.getElementById('taskContainer');
            const tasksDiv = document.getElementById('tasks');
            tasksDiv.innerHTML = '';

            tasks.forEach(task => {
                const taskRow = document.createElement('div');
                taskRow.className = 'task-row mb-3';

                const taskLabel = document.createElement('label');
                taskLabel.className = 'form-label';
                taskLabel.innerText = `Task: ${task.name} (ID: ${task.id})`;
                taskRow.appendChild(taskLabel);

                if (task.connections.length > 0) {
                    const connectionList = document.createElement('ul');
                    task.connections.forEach(connection => {
                        const listItem = document.createElement('li');
                        if (connection !== 'No text associated with this line') {
                            const dropdown = document.createElement('select');
                            dropdown.className = 'form-select mt-1';
                            dropdown.innerHTML = `
                                <option value="">Select Status</option>
                                <option value="Pending">Pending</option>
                                <option value="In Review">In Review</option>
                                <option value="Complete">Complete</option>
                            `;

                            const connectionText = document.createElement('span');
                            connectionText.innerText = connection;
                            connectionText.className = 'me-2';

                            listItem.appendChild(connectionText);
                            listItem.appendChild(dropdown);
                        } else {
                            listItem.innerText = connection;
                        }
                        connectionList.appendChild(listItem);
                    });
                    taskRow.appendChild(connectionList);
                } else {
                    const noConnectionMessage = document.createElement('p');
                    noConnectionMessage.innerText = 'No connections associated with this task.';
                    noConnectionMessage.className = 'text-muted';
                    taskRow.appendChild(noConnectionMessage);
                }

                tasksDiv.appendChild(taskRow);
            });

            taskContainer.classList.remove('d-none');
        }
    </script>
</body>
</html>
